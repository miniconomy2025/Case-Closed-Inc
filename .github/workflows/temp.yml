name: Deployment Pipeline
env:
  AWS_REGION: af-south-1

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-api:
    name: Build & Deploy to EC2
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server

    steps:
      # === Code Checkout ===
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch Parameters
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get SSM Parameters + TF Outputs
        run: |
          # GET SSL Certs from SSM
            aws ssm get-parameter --name "/ssl/crt" --query "Parameter.Value" --output text > /tmp/ssl_cert.crt
            aws ssm get-parameter --name "/ssl/privkey_pem" --query "Parameter.Value" --output text > /tmp/ssl_key.pem
      
      - name: Upload SSL Certs to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
            host: 13.246.82.211
            username: ${{ secrets.EC2_USER }}
            key: ${{ secrets.EC2_SSH_KEY }}
            port: 22
            source: |
                /tmp/ssl_cert.crt
                /tmp/ssl_key.pem
            target: /etc/ssl/casesupplier/
      
      
      
            # === Deploy on EC2 ===
    #   - name: Upload SSL Certs and Configure Nginx
    #     uses: appleboy/ssh-action@v1.0.0
    #     with:
    #         host: 13.246.82.211
    #         username: ${{ secrets.EC2_USER }}
    #         key: ${{ secrets.EC2_SSH_KEY }}
    #         port: 22
    #         script: |
    #             set -e        
    #             sudo mkdir -p /etc/ssl/casesupplier/

    #             sudo bash -c "cat > /etc/ssl/casesupplier/casesupplier_cert.crt" << EOF
    #             ${{ steps.ssm.outputs.ssl_cert }}
    #             EOF

    #             sudo bash -c "cat > /etc/ssl/casesupplier/casesupplier_key.pem" << EOF
    #             ${{ steps.ssm.outputs.ssl_key }}
    #             EOF

    #             sudo chmod 644 /etc/ssl/casesupplier/casesupplier_cert.crt
    #             sudo chmod 600 /etc/ssl/casesupplier/casesupplier_key.pem

            
